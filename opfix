#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

CHECK="${GREEN}✔${NC}"
CROSS="${RED}✖${NC}"
INFO="${CYAN}➜${NC}"
WARN="${YELLOW}⚠${NC}"

DYLIB_URL="https://x099xkycxe.ufs.sh/f/ar75CUBjeUn907ZDaL9RvnwtPqsyrWQGdUaCf8TDJlbXuYZ3"
MODULES_URL="https://x099xkycxe.ufs.sh/f/ar75CUBjeUn9sVKnsuNRLpwIiVkxYvTUQnAuFbGoSEH1tPMO"
UI_URL="https://x099xkycxe.ufs.sh/f/ar75CUBjeUn9SqRVN7ZrzmeZJ1BNkhvFnjVlg3PaHqYESfiU"

DEBUG=0
[[ "${1:-}" == "--debug" ]] && DEBUG=1

dbg()  { [[ "$DEBUG" -eq 1 ]] && echo -e "${YELLOW}[DBG]${NC} $*" || true; }
step() { echo -e "\n${BOLD}${CYAN}==> $1${NC}"; }
ok()   { echo -e "${CHECK} $1"; }
info() { echo -e "${INFO} $1"; }
warn() { echo -e "${WARN} $1"; }
fail() { echo -e "${CROSS} ${RED}$1${NC}"; exit 1; }

verify_signed() {
    local path="$1"
    if codesign -v "$path" 2>/dev/null; then
        ok "$(basename "$path") — signed"
    else
        echo -e "${CROSS} ${RED}$(basename "$path") is UNSIGNED — aborting${NC}"
        codesign -dvv "$path" 2>&1 | sed "s/^/  /"
        exit 1
    fi
}

if [ -w "/Applications" ]; then
    APP_DIR="/Applications"
    info "Installing to /Applications"
else
    APP_DIR="$HOME/Applications"
    mkdir -p "$APP_DIR"
    warn "No write access to /Applications — using $APP_DIR"
fi

TEMP="$(mktemp -d)"
dbg "Temp dir: $TEMP"

cleanup() {
    local code=$?
    if [[ $code -ne 0 ]]; then
        echo -e "\n${RED}${BOLD}Installation failed (exit $code)${NC}"
        warn "Temp dir kept for inspection: $TEMP"
    else
        rm -rf "$TEMP"
    fi
}
trap cleanup EXIT

echo -e "${BOLD}"
cat <<'EOF'
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%*=--::=*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#+-:..........:+@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@#+-:..............-+@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@%#=-:...:-=+*#%%%#*-.:=*@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##*=-:.::=*#@@@@@@@@@@@@+-#@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#+-..:-+%@@@@@@@@@@@@@@@@#*@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%+=:.:=*%@@@@@@@@@@@@@@@@@@@+@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*+-.:=*%@@@@@=%@@@@@@@@@@@@@@#@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*+:.-##@@@@@@@@@@#=@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%*=::+#%@@@@@@@@@@@@@@*:#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%**==*#@@@@@@@@@@@@@@@@@@@*-:@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%#=-*%@@@@@@@@@@@@@@@@@@@@@@%+-+=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@%#+=*%@@@@@@@@@@@@@@@@@@@@@@@@@++===**#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@%#*=+#@@@@@@@@@@@@@@@@@@@@@@@@@@@=::---=++###%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@##+-*%@@@@@@@@@@@@@@@@@@@%%%##*+=-=------=++===+***+*##%%%%%@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@**-+%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%#*+=-=+++******%%%@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@-+-+%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%#+=+**#*%@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@-=:+%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%***#*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@#.:=*%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%#*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@-:-+%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@*=----@@@@@%##@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
EOF
echo -e "${NC}"
echo -e "${BLUE}=[ Opiumware (Intel) Installer ]=${NC}"
echo -e "${CYAN}Developed by @norbyv1${NC}"
[[ "$DEBUG" -eq 1 ]] && warn "Debug mode ON"

step "Killing existing processes"
killall -9 RobloxPlayer Opiumware &>/dev/null && ok "Killed existing instances" || ok "No existing instances running"

step "Removing old installations"
for target in "$APP_DIR/Roblox.app" "$APP_DIR/Opiumware.app"; do
    if [ -e "$target" ]; then
        rm -rf "$target" 2>/dev/null || sudo rm -rf "$target" 2>/dev/null || fail "Could not remove $target — delete it manually and rerun"
        ok "Removed $target"
    else
        info "$(basename "$target") not present, skipping"
    fi
done
rm -rf ~/Opiumware/modules/LuauLSP ~/Opiumware/modules/decompiler
rm -f ~/Opiumware/modules/update.json 2>/dev/null || true

step "Fetching client version"
VERSION="version-6298eb58de444612"
ok "Version: $VERSION"

MIMALLOC="$APP_DIR/Roblox.app/Contents/MacOS/libmimalloc.3.dylib"

step "Downloading Roblox ($VERSION)"
info "Fetching RobloxPlayer.zip..."
curl -# -L "https://setup.rbxcdn.com/mac/$VERSION-RobloxPlayer.zip" -o "$TEMP/RobloxPlayer.zip" || fail "Download failed"
info "Extracting..."
unzip -oq "$TEMP/RobloxPlayer.zip" -d "$TEMP" || fail "Extraction failed"
[[ -d "$TEMP/RobloxPlayer.app" ]] || fail "RobloxPlayer.app not found after extraction"
mv "$TEMP/RobloxPlayer.app" "$APP_DIR/Roblox.app"
xattr -cr "$APP_DIR/Roblox.app"
ok "Roblox.app installed"
dbg "RobloxPlayer size: $(du -sh "$APP_DIR/Roblox.app/Contents/MacOS/RobloxPlayer" 2>/dev/null | cut -f1)"
[[ -f "$MIMALLOC" ]] || fail "libmimalloc.3.dylib missing — unexpected bundle layout"
ok "libmimalloc.3.dylib present"

step "Downloading libOpiumware"
curl -# -L "$DYLIB_URL" -o "$TEMP/libOpiumware.zip" || fail "libOpiumware download failed"
unzip -oq "$TEMP/libOpiumware.zip" -d "$TEMP" || fail "libOpiumware extraction failed"
[[ -f "$TEMP/libOpiumware.dylib" ]] || fail "libOpiumware.dylib not found in archive"
mv "$TEMP/libOpiumware.dylib" "$APP_DIR/Roblox.app/Contents/Resources/libOpiumware.dylib"
ok "libOpiumware.dylib placed"

step "Injecting into libmimalloc"
curl -# -L "$MODULES_URL" -o "$TEMP/modules.zip" || fail "Modules download failed"
unzip -oq "$TEMP/modules.zip" -d "$TEMP" || fail "Modules extraction failed"
[[ -f "$TEMP/Resources/Injector" ]] || fail "Injector binary not found in modules archive"
chmod +x "$TEMP/Resources/Injector"
info "Running Injector..."
"$TEMP/Resources/Injector" \
    "$APP_DIR/Roblox.app/Contents/Resources/libOpiumware.dylib" \
    "$MIMALLOC" \
    --strip-codesig --all-yes 2>&1 | sed "s/^/  /" || fail "Injector exited with error"
PATCHED="${MIMALLOC}_patched"
if [[ ! -f "$PATCHED" ]]; then
    echo -e "${CROSS} ${RED}Patched dylib not produced. MacOS dir:${NC}"
    ls -lah "$APP_DIR/Roblox.app/Contents/MacOS/" | sed "s/^/  /"
    exit 1
fi
mv "$PATCHED" "$MIMALLOC"
ok "libmimalloc.3.dylib patched"

step "Signing patched libmimalloc.3.dylib"
codesign --force --sign - "$MIMALLOC" 2>&1 | sed "s/^/  /" || fail "codesign failed on libmimalloc.3.dylib"
verify_signed "$MIMALLOC"

step "Installing Opiumware UI"
curl -# -L "$UI_URL" -o "$TEMP/OpiumwareUI.zip" || fail "UI download failed"
unzip -oq "$TEMP/OpiumwareUI.zip" -d "$TEMP" || fail "UI extraction failed"
mkdir -p ~/Opiumware/workspace ~/Opiumware/autoexec ~/Opiumware/themes \
         ~/Opiumware/modules ~/Opiumware/modules/decompiler ~/Opiumware/modules/LuauLSP
mv -f "$TEMP/Resources/decompiler" ~/Opiumware/modules/decompiler/Decompiler
mv -f "$TEMP/Resources/LuauLSP"    ~/Opiumware/modules/LuauLSP/LuauLSP
[[ -d "$TEMP/Opiumware.app" ]] || fail "Opiumware.app not found in UI archive"
mv -f "$TEMP/Opiumware.app" "$APP_DIR/Opiumware.app"
codesign --force --deep --sign - --identifier com.norbyv1.opiumware "$APP_DIR/Opiumware.app" 2>&1 | sed "s/^/  /" || true
tccutil reset ScreenCapture com.norbyv1.opiumware >/dev/null 2>&1 || true
ok "Opiumware.app installed"

step "Final codesign"
info "Deep-signing Roblox.app..."
codesign --force --deep --sign - "$APP_DIR/Roblox.app" 2>&1 | sed "s/^/  /" || fail "Final codesign failed"
rm -rf "$APP_DIR/Roblox.app/Contents/MacOS/RobloxPlayerInstaller.app" 2>/dev/null || true
tccutil reset Accessibility com.Roblox.RobloxPlayer >/dev/null 2>&1 || true
ok "Roblox.app signed"

if [[ "$DEBUG" -eq 1 ]]; then
    step "Debug: signature report"
    for f in \
        "$APP_DIR/Roblox.app/Contents/MacOS/RobloxPlayer" \
        "$MIMALLOC" \
        "$APP_DIR/Roblox.app/Contents/Resources/libOpiumware.dylib" \
        "$APP_DIR/Opiumware.app"
    do
        echo -e "${INFO} $(basename "$f")"
        codesign -dvv "$f" 2>&1 | sed "s/^/  /"
    done
fi

echo
echo -e "${GREEN}${BOLD}Installation complete.${NC}"
warn "Please use an alt account."
echo
open "$APP_DIR/Roblox.app"
open "$APP_DIR/Opiumware.app"
